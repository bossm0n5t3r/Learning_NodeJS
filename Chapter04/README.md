# Creating a Web server with the http module

## Request and Response
- 클라이언트 --- 요청 (request)  --> 서버
- 클라이언트 <-- 응답 (response) --- 서버
- [createServer.js](./4.1/createServer.js)
  - http 서버가 있어야 웹 브라우저의 요청을 처리할 수 있으므로 [http 모듈](https://nodejs.org/api/http.html) 사용
  - createServer
    - http 모듈에 포함
    - 인자로 요청에 대한 콜백함수를 넣을 수 있음
    - 요청이 들어올 때마다 매번 콜백 함수가 실행
    - 따라서 콜백 함수에 응답을 적어주면 됨
    - 콜백 함수의 매개 변수
      - 매개 변수의 이름은 자유롭게 바꿔도 됨
      - req (request)
        - 요청에 관한 정보
      - res (response)
        - 응답에 관한 정보
- [server1.js](./4.1/server1.js)
  - createServer 메서드 뒤에 listen 메서드를 붙이고 클라이언트에게 공개할 포트 번호와 포트 연결 완료 후 실행될 콜백 함수를 넣어줌
  - 이 파일을 실행하면 서버는 8080 포트에서 요청 대기
- [server1-0.js](./4.1/server1-0.js)
  - [server1.js](./4.1/server1.js)에서 listen 메서드에 콜백 함수를 넣는 대신, [server1-0.js](./4.1/server1-0.js)같이 서버에 listening 이벤트 리스너를 붙여도 됨
  - 추가로 error 이벤트 리스너도 붙임
  - res 객체에는 [res.write](https://nodejs.org/api/http.html#http_response_write_chunk_encoding_callback) 와 [res.end](https://nodejs.org/api/http.html#http_response_end_data_encoding_callback) 메서드가 있음
    - [res.write](https://nodejs.org/api/http.html#http_response_write_chunk_encoding_callback)
      - 첫 번째 parameter는 chunk
        - 반드시 포함
        - chunk는 string 또는 buffer 로 구성되어 있음
        - 만약 chunk가 string이면, 두 번째 parameter는 byte stream으로 인코딩하는 방법을 지정
        - 클라이언트로 보낼 데이터
      - 두 번째 parameter는 encoding
        - 생략이 가능함
        - Default : 'utf-8'
      - 세 번째 parameter는 callback function
        - 생략이 가능함
        - chunk of data 가 flushed 되면 호출됨
    - [res.end](https://nodejs.org/api/http.html#http_response_end_data_encoding_callback)
      - 응답을 종료하는 메서드
      - 만약 data가 있다면, data도 클라이언트에 보내고 응답을 종료
      - 이 method 는 **반드시 각각의 response 마다 호출**해야 함
        - 안하는 경우 클라이언트는 호출되기를 계속 대기
- [server2.html](./4.1/server2.html), [server2.js](./4.1/server2.js)
  - 요청이 들어오면 fs 모듈로 HTML 파일을 읽음
  - 그리고 data 변수에 저장된 버퍼를 그대로 클라이언트에 보내면 됨

## Cookie and Session
- Cookie 란?
  - 'key - value' 쌍
  - 서버는 미리 클라이언트에 요청자가 추정할 만한 정보를 쿠키로 만들어 보내고, 그 다음부터는 클라이언트로부터 쿠키를 받아 요청자를 파악
  - 쿠키는 사용자가 누구인지 추적
  - 요청과 응답의 헤더(header)에 저장
  - 요청과 응답은 각각 헤더(header)와 본문(body)을 가짐
- [server3.js](./4.2/server3.js)
  - parseCookies
    - 쿠키는 name=mudo;year=2005 처럼 문자열 형식으로 오므로 이를 { name: 'mudo', year: '2005' } 와 같이 객체로 바꾸는 함수
  - createServer
    - 콜백에서는 제일 먼저 req 객체의 쿠키를 분석
    - 쿠키는 req.headers.cookie 에 들어있음
    - req.headers 는 요청의 헤더를 의미
    - 응답의 헤더에 쿠키를 기록하려면 res.writeHead 메서드 사용
    - res.writeHead
      - 첫 번째 인자
        - 200 : 성공의 의미
      - 두 번째 인자
        - 헤더의 내용을 입력
        - Set-Cookie 는 브라우저한테 다음과 같은 값의 쿠키를 저장하라는 의미
        - 실제로 응답을 받은 브라우저는 mycookie=test 라는 쿠키를 저장
- HTTP 상태 코드
  - 2XX
    - 성공을 알리는 상태 코드
    - 200(성공), 201(작성됨)
  - 3XX
    - 리다이렉션(다른 페이지로 이동)을 알리는 상태 코드
    - 어떤 주소를 입력했는데 다른 주소의 페이지로 넘어갈 때 이 코드가 사용
    - 301(영구 이동), 302(임시 이동)
  - 4XX
    - 요청 오류
    - 요청 자체에 오류가 있을 때 표시
    - 401(권한 없음), 403(금지됨), 404(찾을 수 없음)
  - 5XX
    - 서버 오류
    - 요청은 제대로 왔지만 서버에 오류가 생겼을 때 발생
    - 서버가 알아서 5XX대 코드를 보냄
    - 500(내부 서버 오류), 502(불량 게이트웨이), 503(서비스를 사용할 수 없음)
- [server4.html](./4.2/server4.html), [server4.js](./4.2/server4.js)
  - 쿠키 설정 옵션
    - 쿠키명=쿠키값
      - 기본적인 쿠키의 값
    - Expires=날짜
      - 만료 기한
      - 기본 값
        - 클라이언트가 종료될 때 까지
    - Max-age=초
      - Expires와 비슷하지만 날짜 대신 초를 입력
      - 초가 지나면 쿠키가 제거
      - Expires보다 우선
    - Domain=도메인명
      - 쿠키가 전송될 도메인을 특정
      - 기본값
        - 현재 도메인
    - Path=URL
      - 쿠키가 전송될 URL을 특정
      - 기본값
        - /
          - 이 경우 모든 URL에서 쿠키를 전송 가능
    - Secure
      - HTTPS일 경우에만 쿠키가 전송
    - HttpOnly
      - 설정 시 자바스크립트에서 쿠키에 접근할 수 없음
      - 쿠키 조작을 방지하기 위해 설정하는 것이 좋음
- [server5.js](./4.2/server5.js)
  - 이름 같은 민감한 개인정보를 쿠키에 넣어두는 것은 적절하지 못함
  - 쿠키에 이름을 담아서 보내는 대신, randomInt 라는 임의의 숫자를 보냄
  - 사용자의 이름과 만료시간은 session 이라는 객체에 대신 저장
  - cookie.session 이 있고 만료 기한을 넘기지 않았다면 session 변수에서 사용자 정보를 가져와서 사용